name: Fix PR

on:
  workflow_call:
    secrets:
      ANTHROPIC_API_KEY:
        required: true

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  fix:
    if: >
      (
        github.event_name == 'check_suite' &&
        github.event.check_suite.conclusion == 'failure' &&
        github.event.check_suite.head_branch != 'main' &&
        github.event.check_suite.head_branch != 'master' &&
        github.event.check_suite.head_branch != 'staging'
      ) ||
      (
        github.event_name == 'issue_comment' &&
        contains(github.event.comment.body, '/fix-pr') &&
        github.event.issue.pull_request
      )
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Determine PR info
        id: pr-info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            PR_NUMBER="${{ github.event.issue.number }}"
          else
            # check_suite â€” find the PR for this head branch
            PR_NUMBER=$(gh api "repos/${{ github.repository }}/pulls?head=${{ github.repository_owner }}:${{ github.event.check_suite.head_branch }}&state=open" \
              --jq '.[0].number' 2>/dev/null || echo "")
          fi

          if [[ -z "$PR_NUMBER" || "$PR_NUMBER" == "null" ]]; then
            echo "No open PR found. Skipping."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          HEAD_REF=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json headRefName -q .headRefName)
          BASE_REF=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json baseRefName -q .baseRefName)

          # Guard: skip protected branches
          if [[ "$HEAD_REF" == "main" || "$HEAD_REF" == "master" || "$HEAD_REF" == "staging" ]]; then
            echo "Refusing to modify protected branch: $HEAD_REF"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "head_ref=$HEAD_REF" >> "$GITHUB_OUTPUT"
          echo "base_ref=$BASE_REF" >> "$GITHUB_OUTPUT"
          echo "skip=false" >> "$GITHUB_OUTPUT"

      - name: Checkout PR branch
        if: steps.pr-info.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr-info.outputs.head_ref }}
          fetch-depth: 0
          token: ${{ github.token }}

      - name: Install Claude Code
        if: steps.pr-info.outputs.skip != 'true'
        run: npm install -g @anthropic-ai/claude-code

      - name: Gather PR context and run Claude
        if: steps.pr-info.outputs.skip != 'true'
        id: fix
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.pr-info.outputs.pr_number }}
        run: |
          # Download and run the context gathering script
          PROMPT=$(bash <(curl -sL "https://raw.githubusercontent.com/deployhq/claude-fix-pr/main/scripts/gather-pr-context.sh") "$PR_NUMBER" "${{ github.repository }}")

          # Run Claude with scoped tools
          SUMMARY=$(echo "$PROMPT" | claude -p \
            --allowedTools 'Edit,Write,Read,Grep,Glob,Bash(git diff:*),Bash(bin/rspec:*),Bash(rubocop:*),Bash(go test:*),Bash(yarn test:*),Bash(npm test:*)' \
            2>/dev/null || echo "Claude encountered an error while processing.")

          # Save summary for later steps
          echo "$SUMMARY" > /tmp/fix-summary.md

      - name: Commit and push fixes
        if: steps.pr-info.outputs.skip != 'true'
        env:
          PR_NUMBER: ${{ steps.pr-info.outputs.pr_number }}
        run: |
          git config user.name "claude-fix-pr[bot]"
          git config user.email "claude-fix-pr[bot]@users.noreply.github.com"
          git add -A

          if git diff --cached --quiet; then
            echo "No changes to commit."
            echo "## No Issues Found" > /tmp/fix-summary.md
            echo "Claude analyzed the PR and found no issues to fix." >> /tmp/fix-summary.md
            exit 0
          fi

          git commit -m "fix: address PR feedback for #${PR_NUMBER}

          Co-Authored-By: claude-fix-pr[bot] <claude-fix-pr[bot]@users.noreply.github.com>"
          git push

      - name: Comment on PR
        if: steps.pr-info.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.pr-info.outputs.pr_number }}
        run: |
          SUMMARY=$(cat /tmp/fix-summary.md 2>/dev/null || echo "Fix completed.")
          BODY=$(cat <<EOF
          ## Claude Fix-PR Summary

          $SUMMARY

          ---
          _Automated by [claude-fix-pr](https://github.com/deployhq/claude-fix-pr)_
          EOF
          )
          gh pr comment "$PR_NUMBER" --body "$BODY"
